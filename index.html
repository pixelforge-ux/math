<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿ¨ÿØŸàŸÑ ÿ±€åÿßÿ∂€å</title>
    <script src="https://developer.eitaa.com/eitaa-web-app.js"></script>
    <style>
        :root {
            --primary: #6c5ce7;
            --primary-dark: #4834d4;
            --secondary: #00b894;
            --danger: #ff7675;
            --dark: #1a1c2c;
            --light: #f9f9f9;
            --accent: #fdcb6e;
            --bg-color: #0f172a;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-thick: rgba(255, 255, 255, 0.2);
            --shadow-3d: 0 20px 50px rgba(0,0,0,0.3), 0 10px 10px rgba(0,0,0,0.2);
            --surface: #ffffff;
            --glow: 0 0 20px rgba(108, 92, 231, 0.4);
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Vazirmatn', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(108, 92, 231, 0.3) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(0, 184, 148, 0.2) 0%, transparent 40%);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #fff;
            height: 100vh;
            overflow: hidden;
            direction: rtl;
            perspective: 1200px;
        }

        /* 4D Animated Background Elements */
        .bg-blobs {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2;
            overflow: hidden;
            pointer-events: none;
        }

        #gfx-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            opacity: 0;
            transition: opacity 1s ease;
        }

        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.6;
            mix-blend-mode: screen;
            animation: move 25s infinite alternate ease-in-out;
            transform-style: preserve-3d;
        }

        .blob-1 { width: 40vw; height: 40vw; background: linear-gradient(45deg, var(--primary), #a29bfe); top: -10%; left: -10%; animation-duration: 15s; }
        .blob-2 { width: 35vw; height: 35vw; background: linear-gradient(45deg, var(--secondary), #55efc4); bottom: -5%; right: -5%; animation-duration: 20s; animation-delay: -5s; }
        .blob-3 { width: 20vw; height: 20vw; background: linear-gradient(45deg, var(--accent), #fab1a0); top: 40%; left: 60%; animation-duration: 18s; animation-delay: -2s; opacity: 0.3; }

        @keyframes move {
            0% { transform: translate(0, 0) scale(1) rotate(0deg) translateZ(0); }
            50% { transform: translate(10%, 15%) scale(1.2) rotate(180deg) translateZ(50px); }
            100% { transform: translate(-5%, 5%) scale(0.9) rotate(360deg) translateZ(-50px); }
        }

        #app {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .screen {
            display: none;
            flex-direction: column;
            height: 100vh;
            padding: 10px;
            animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden;
            position: relative;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .screen.active {
            display: flex;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .top-bar {
            position: absolute;
            top: 20px;
            left: 20px;
        }

        .stats-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .coin-display {
            display: flex;
            align-items: center;
            background: var(--glass);
            backdrop-filter: blur(4px);
            padding: 6px 16px;
            border-radius: 50px;
            box-shadow: var(--shadow);
            font-weight: 800;
            color: #e67e22;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .coin-icon {
            margin-right: 5px;
            font-size: 1.2rem;
        }

        h1, h2, h3 {
            margin: 0;
        }

        .logo {
            text-align: center;
            margin-top: 50px;
            margin-bottom: 40px;
        }

        .logo h1 {
            font-size: 3.5rem;
            background: linear-gradient(to bottom, #fff, #a29bfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 10px 20px rgba(0,0,0,0.3);
            letter-spacing: -1px;
            font-weight: 900;
        }

        .logo p {
            color: rgba(255,255,255,0.7);
            font-size: 1.1rem;
            margin-top: -10px;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex-grow: 1;
            justify-content: center;
            max-width: 300px;
            margin: 0 auto;
            width: 100%;
        }

        button {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            font-family: inherit;
        }

        button:active {
            transform: scale(0.95);
        }

        .btn-primary { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); 
            color: white; 
            box-shadow: 0 8px 20px rgba(108, 92, 231, 0.4);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .btn-primary::after {
            content: '';
            position: absolute;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: rotate(45deg);
            transition: 0.5s;
            pointer-events: none;
        }
        .btn-primary:active::after {
            left: 100%;
        }
        .btn-outline { 
            background: rgba(255, 255, 255, 0.5);
            color: var(--primary); 
            border: 2px solid var(--primary); 
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .btn-danger { 
            background: linear-gradient(135deg, var(--danger) 0%, #d63031 100%); 
            color: white; 
            margin-top: 20px; 
        }

        .btn-hint {
            background: var(--accent);
            color: var(--dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 90px;
            height: 65px;
            margin: 0 auto 10px auto;
            font-weight: bold;
            box-shadow: 0 4px 0 #d4ac0d;
            border-radius: 15px;
            padding: 5px;
        }

        .hint-main {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-hint .icon {
            font-size: 1.2rem;
        }

        .hint-badge {
            background: white;
            padding: 1px 5px;
            border-radius: 8px;
            font-size: 0.7rem;
            min-width: 25px;
        }

        .hint-cost {
            font-size: 0.8rem;
            color: #d35400;
            margin-top: 2px;
        }

        .btn-hint:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #d4ac0d;
        }

        .back-btn {
            background: white;
            color: var(--dark);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 45px;
            height: 45px;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
        }

        .levels-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            overflow-y: auto;
            padding: 20px 10px;
            flex-grow: 1;
            perspective: 1000px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .level-card {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: 900;
            font-size: 1.6rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2), inset 0 0 0 1px rgba(255,255,255,0.1);
            position: relative;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: white;
            transform-style: preserve-3d;
        }

        .level-card:active {
            transform: scale(0.9) translateZ(-20px);
        }

        .level-card.locked {
            background: rgba(189, 195, 199, 0.4);
            color: rgba(0,0,0,0.2);
            cursor: not-allowed;
            border-color: transparent;
            backdrop-filter: blur(8px);
        }

        .level-card.locked::after {
            content: 'üîí';
            font-size: 1rem;
            margin-top: 5px;
            opacity: 0.5;
        }

        .level-card.solved {
            background: linear-gradient(145deg, #00b894, #55efc4);
            color: white;
            border-color: #55efc4;
            box-shadow: 0 8px 15px rgba(0, 184, 148, 0.3);
        }

        .level-card.solved::after {
            content: '‚úÖ';
            font-size: 0.7rem;
            position: absolute;
            top: 5px;
            right: 5px;
        }

        .level-card.current {
            background: white;
            border: 4px solid var(--primary);
            color: var(--primary);
            box-shadow: 0 0 20px rgba(108, 92, 231, 0.4);
            animation: pulseGlow 2s infinite ease-in-out;
            z-index: 5;
        }

        @keyframes pulseGlow {
            0% { transform: scale(1); box-shadow: 0 0 10px rgba(108, 92, 231, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 25px rgba(108, 92, 231, 0.6); }
            100% { transform: scale(1); box-shadow: 0 0 10px rgba(108, 92, 231, 0.4); }
        }

        #game-container {
            flex: 1 1 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 0;
            width: 100%;
            margin-bottom: 5px;
        }

        #math-grid {
            display: grid;
            gap: 8px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 28px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.4), inset 0 0 0 1px rgba(255,255,255,0.15);
            backdrop-filter: blur(30px);
            max-width: 95vw;
            transform: rotateX(5deg) rotateY(-5deg);
            transition: transform 0.5s ease-out;
            transform-style: preserve-3d;
        }

        .cell {
            width: 15vmin;
            height: 15vmin;
            max-width: 54px;
            max-height: 54px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 900;
            font-size: 1.4rem;
            border-radius: 16px;
            background: rgba(255,255,255,0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2), inset 0 1px 1px rgba(255,255,255,0.2);
            color: #fff;
            transform-style: preserve-3d;
        }

        .cell.empty { background: transparent; box-shadow: none; visibility: hidden; }
        .cell.operator { 
            background: transparent;
            color: var(--accent); 
            font-size: 1.6rem;
            border: none;
            box-shadow: none;
            text-shadow: 0 0 10px rgba(253, 203, 110, 0.4);
        }
        .cell.result { 
            background: rgba(255,255,255,0.05); 
            color: #fff; 
            border: 2px solid rgba(255,255,255,0.1);
            font-weight: 900;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.2);
        }
        .cell.input { 
            background: rgba(255,255,255,0.15); 
            border: 2px solid rgba(255,255,255,0.2); 
            color: white;
            cursor: pointer;
        }
        .cell.input.selected {
            border-color: var(--primary);
            box-shadow: 0 0 20px var(--primary), inset 0 0 10px var(--primary);
            transform: translateZ(10px) scale(1.1);
            z-index: 10;
        }

        .cell.input.fixed {
            cursor: default;
            background: rgba(255,255,255,0.03);
            border-color: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.4);
            box-shadow: none;
        }

        .cell.correct {
            background: linear-gradient(135deg, #00b894, #55efc4) !important;
            color: #fff !important;
            border-color: #fff !important;
            box-shadow: 0 0 20px rgba(0, 184, 148, 0.6);
        }

        .cell.incorrect {
            background: linear-gradient(135deg, #d63031, #ff7675) !important;
            color: #fff !important;
            border-color: #fff !important;
            box-shadow: 0 0 20px rgba(255, 118, 117, 0.6);
        }

        .game-footer-controls {
            display: flex;
            justify-content: center;
            margin-bottom: 5px;
            flex-shrink: 0;
        }

        .numpad {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 4px;
            margin-top: 0;
            flex-shrink: 0;
        }

        .numpad button {
            padding: 10px 0;
            font-size: 1.3rem;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 0 rgba(0,0,0,0.3);
            border-radius: 16px;
            font-weight: 900;
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            transition: all 0.1s;
        }
        .numpad button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.1);
        }

        .numpad .clear {
            grid-column: span 2;
            background: #ff7675;
            color: white;
            font-size: 0.8rem;
            padding: 0;
        }

        .footer-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 0.75rem 1rem;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(transparent, rgba(2, 6, 23, 0.9) 40%);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        .ads-button {
            background: linear-gradient(135deg, #f97316, #c2410c);
            color: white !important;
            text-decoration: none !important;
            padding: 0.6rem 2rem;
            border-radius: 999px;
            font-size: 0.875rem;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ads-button:active {
            transform: scale(0.94) translateY(2px);
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.3);
            background: linear-gradient(135deg, #ea580c, #9a3412);
        }

        .screen {
            padding-bottom: 70px !important;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            color: var(--dark);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input { opacity: 0; width: 0; height: 0; }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px; width: 18px;
            left: 4px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider { background-color: var(--secondary); }
        input:checked + .slider:before { transform: translateX(24px); }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            color: var(--dark);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            width: 80%;
            max-width: 300px;
            animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* WebView Styles */
        .loader-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: rgba(255,255,255,0.8);
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #ads-frame {
            flex: 1;
            width: 100%;
            border: none;
            border-radius: 12px;
            background: white;
            margin-top: 10px;
        }

        @keyframes bounceIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @media (max-width: 400px) {
            .cell { width: 40px; height: 40px; font-size: 1rem; }
            .levels-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <canvas id="gfx-canvas"></canvas>
    <div class="bg-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>
    <div id="app">
        <!-- Main Menu -->
        <section id="main-menu" class="screen active">
            <div class="logo">
                <h1>ÿ¨ÿØŸàŸÑ ÿ±€åÿßÿ∂€å</h1>
                <p>ŸáŸàÿ¥ ÿÆŸàÿØ ÿ±ÿß ÿ®Ÿá ⁄ÜÿßŸÑÿ¥ ÿ®⁄©ÿ¥€åÿØ</p>
            </div>
            <div class="coin-display top-bar">
                <span id="menu-coin-count">€≤€∞</span>
                <span class="coin-icon">üí∞</span>
            </div>
            <div class="menu-buttons">
                <button class="btn-primary" onclick="ui.showScreen('level-select')">ÿ¥ÿ±Ÿàÿπ ÿ®ÿßÿ≤€å</button>
                <button class="btn-outline" onclick="ui.showScreen('settings')">ÿ™ŸÜÿ∏€åŸÖÿßÿ™</button>
            </div>
        </section>

        <!-- Level Select -->
        <section id="level-select" class="screen">
            <header>
                <button class="back-btn" onclick="ui.back()">‚Üê</button>
                <h2>ÿßŸÜÿ™ÿÆÿßÿ® ŸÖÿ±ÿ≠ŸÑŸá</h2>
                <div class="coin-display">
                    <span class="coin-count">€≤€∞</span>
                    <span class="coin-icon">üí∞</span>
                </div>
            </header>
            <div class="levels-grid" id="levels-container">
                <!-- Levels will be injected here -->
            </div>
        </section>

        <!-- Game Screen -->
        <section id="game-screen" class="screen">
            <header>
                <button class="back-btn" onclick="ui.back()">‚Üê</button>
                <div id="level-indicator">ŸÖÿ±ÿ≠ŸÑŸá €±</div>
                <div class="stats-group">
                    <div class="coin-display">
                        <span class="coin-count">€≤€∞</span>
                        <span class="coin-icon">üí∞</span>
                    </div>
                    <span id="timer">€∞€∞:€∞€∞</span>
                </div>
            </header>
            
            <div id="game-container">
                <div id="math-grid"></div>
            </div>

            <div class="game-footer-controls">
                <button class="btn-hint" onclick="game.useHint()">
                    <div class="hint-main">
                        <span class="icon">üí°</span>
                        <span id="hint-count" class="hint-badge">€≤/€≤</span>
                    </div>
                    <div class="hint-cost">€µ üí∞</div>
                </button>
            </div>

            <div class="numpad">
                <button onclick="game.inputNumber(1)">€±</button>
                <button onclick="game.inputNumber(2)">€≤</button>
                <button onclick="game.inputNumber(3)">€≥</button>
                <button onclick="game.inputNumber(4)">€¥</button>
                <button onclick="game.inputNumber(5)">€µ</button>
                <button onclick="game.inputNumber(6)">€∂</button>
                <button onclick="game.inputNumber(7)">€∑</button>
                <button onclick="game.inputNumber(8)">€∏</button>
                <button onclick="game.inputNumber(9)">€π</button>
                <button onclick="game.inputNumber(0)">€∞</button>
                <button class="clear" onclick="game.clearCell()">Ÿæÿß⁄©</button>
            </div>
        </section>



        <!-- Settings -->
        <section id="settings" class="screen">
            <header>
                <button class="back-btn" onclick="ui.back()">‚Üê</button>
                <h2>ÿ™ŸÜÿ∏€åŸÖÿßÿ™</h2>
            </header>
            <div class="settings-content">
                <div class="setting-item">
                    <span>ÿµÿØÿß€å ÿ®ÿßÿ≤€å</span>
                    <label class="switch">
                        <input type="checkbox" id="sound-toggle" checked onchange="audio.toggleSound(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span>⁄Øÿ±ÿßŸÅ€å⁄© ÿ®ÿßŸÑÿß</span>
                    <label class="switch">
                        <input type="checkbox" id="gfx-toggle" checked onchange="ui.toggleGFX(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <button class="btn-danger" onclick="game.resetProgress()">Ÿæÿß⁄© ⁄©ÿ±ÿØŸÜ Ÿæ€åÿ¥ÿ±ŸÅÿ™</button>
            </div>
        </section>

        <!-- Ads WebView Screen -->
        <section id="ads-screen" class="screen">
            <header>
                <button class="back-btn" onclick="ui.back()">‚Üê</button>
                <h2>ÿ´ÿ®ÿ™ ÿ™ÿ®ŸÑ€åÿ∫ÿßÿ™</h2>
            </header>
            <div id="ads-loader" class="loader-container">
                <div class="loader"></div>
                <p>ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å...</p>
            </div>
            <iframe id="ads-frame" src="" frameborder="0" style="display:none;"></iframe>
        </section>

        <!-- Win Modal -->
        <div id="win-modal" class="modal">
            <div class="modal-content">
                <h3>ÿ™ÿ®ÿ±€å⁄©!</h3>
                <p>ŸÖÿ±ÿ≠ŸÑŸá ÿ®ÿß ŸÖŸàŸÅŸÇ€åÿ™ ÿ≠ŸÑ ÿ¥ÿØ.</p>
                <button class="btn-primary" onclick="game.nextLevel()">ŸÖÿ±ÿ≠ŸÑŸá ÿ®ÿπÿØ</button>
            </div>
        </div>
    </div>

    <footer class="footer-nav">
        <a href="https://eitaa.com/Arvinweb" class="ads-button" onclick="app.openArvin(event)">
            <span class="icon">üì¢</span>
            <span>ÿ´ÿ®ÿ™ ÿ™ÿ®ŸÑ€åÿ∫ÿßÿ™</span>
        </a>
    </footer>

    <script type="module">
        const audio = {
            enabled: true,
            context: null,
            buffers: {},

            async init() {
                this.enabled = localStorage.getItem('soundEnabled') !== 'false';
                document.getElementById('sound-toggle').checked = this.enabled;
                window.addEventListener('touchstart', () => this.initContext(), { once: true });
                window.addEventListener('click', () => this.initContext(), { once: true });
            },

            initContext() {
                if (!this.context) {
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                    this.loadSound('click', 'click.mp3');
                    this.loadSound('win', 'win.mp3');
                }
            },

            async loadSound(name, url) {
                try {
                    const response = await fetch(url);
                    const arrayBuffer = await response.arrayBuffer();
                    this.buffers[name] = await this.context.decodeAudioData(arrayBuffer);
                } catch (e) {
                    console.error('Error loading sound:', name, e);
                }
            },

            play(name) {
                if (!this.enabled || !this.context || !this.buffers[name]) return;
                const source = this.context.createBufferSource();
                source.buffer = this.buffers[name];
                source.connect(this.context.destination);
                source.start(0);
            },

            toggleSound(enabled) {
                this.enabled = enabled;
                localStorage.setItem('soundEnabled', enabled);
            }
        };

        const ui = {
            screens: {},
            init() {
                this.screens = {
                    'main-menu': document.getElementById('main-menu'),
                    'level-select': document.getElementById('level-select'),
                    'game-screen': document.getElementById('game-screen'),
                    'settings': document.getElementById('settings'),
                    'ads-screen': document.getElementById('ads-screen')
                };

                // Eitaa SDK Integration
                this.pageStack = [];
                if (window.Eitaa?.WebApp) {
                    const App = window.Eitaa.WebApp;
                    App.ready();
                    App.expand();
                    App.setHeaderColor('#0a61db');
                    
                    // Initial state: hide back button on main menu
                    App.BackButton.hide();

                    App.BackButton.onClick(() => {
                        if (this.pageStack.length > 0) {
                            window.history.back();
                            return false; 
                        } else {
                            App.close();
                        }
                    });
                }
                
                // Handle mobile physical back button
                window.addEventListener('popstate', (event) => {
                    // Close win modal if it's open when going back
                    this.hideWinModal();
                    
                    if (this.pageStack.length > 0) {
                        this.pageStack.pop();
                    }

                    if (event.state && event.state.screenId) {
                        this.showScreen(event.state.screenId, false);
                    } else {
                        this.showScreen('main-menu', false);
                    }
                });
                
                // Set initial state
                history.replaceState({ screenId: 'main-menu' }, '');
            },
            // Navigate back through history
            back() {
                window.audio.play('click');
                if (history.state && history.state.screenId !== 'main-menu') {
                    history.back();
                } else {
                    this.showScreen('main-menu');
                }
            },
            showScreen(screenId, pushHistory = true) {
                if (!this.screens[screenId]) return;
                
                // Ensure modal is closed on screen change
                this.hideWinModal();

                // If leaving ads screen, clear iframe to stop any background activity
                if (document.getElementById('ads-screen').classList.contains('active') && screenId !== 'ads-screen') {
                    document.getElementById('ads-frame').src = '';
                }

                Object.values(this.screens).forEach(s => s.classList.remove('active'));
                this.screens[screenId].classList.add('active');
                
                if (screenId === 'level-select') {
                    window.game.renderLevels();
                    setTimeout(() => {
                        const current = document.querySelector('.level-card.current');
                        if (current) current.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                }
                
                this.updateCoinUI();
                
                if (pushHistory) {
                    window.audio.play('click');
                    if (!history.state || history.state.screenId !== screenId) {
                        history.pushState({ screenId }, '');
                        if (screenId !== 'main-menu') {
                            this.pageStack.push(true);
                        }
                    }
                }

                // Update Eitaa BackButton visibility
                if (window.Eitaa?.WebApp) {
                    const App = window.Eitaa.WebApp;
                    if (screenId === 'main-menu') {
                        App.BackButton.hide();
                        this.pageStack = []; // Reset stack on main menu
                    } else {
                        App.BackButton.show();
                    }
                }
            },
            updateCoinUI() {
                const coinDisplays = document.querySelectorAll('.coin-count');
                const menuCoin = document.getElementById('menu-coin-count');
                const val = window.game ? window.game.toPersianDigits(window.game.coins) : '€∞';
                coinDisplays.forEach(el => el.textContent = val);
                if (menuCoin) menuCoin.textContent = val;
            },
            toggleGFX(enabled) {
                const canvas = document.getElementById('gfx-canvas');
                const blobs = document.querySelector('.bg-blobs');
                if (enabled) {
                    canvas.style.opacity = '0.6';
                    if (blobs) blobs.style.display = 'block';
                    gfxEngine.start();
                } else {
                    canvas.style.opacity = '0';
                    if (blobs) blobs.style.display = 'none';
                    gfxEngine.stop();
                }
            },
            showWinModal() {
                document.getElementById('win-modal').classList.add('active');
            },
            hideWinModal() {
                document.getElementById('win-modal').classList.remove('active');
            },
            openAds() {
                const frame = document.getElementById('ads-frame');
                const loader = document.getElementById('ads-loader');
                const url = 'https://forms.gle/UHJ8mChHrEN4WFBa9';
                
                loader.style.display = 'flex';
                frame.style.display = 'none';
                frame.src = url;
                
                frame.onload = () => {
                    loader.style.display = 'none';
                    frame.style.display = 'block';
                };
                
                this.showScreen('ads-screen');
            }
        };

        const game = {
            currentLevel: 1,
            solvedLevels: [],
            gridData: [],
            selectedCell: null,
            totalLevels: 100,
            timer: 0,
            timerInterval: null,
            coins: 20,
            hintCost: 5,
            winReward: 8,
            hintsUsedInLevel: 0,
            maxHintsPerLevel: 2,

            init() {
                this.loadProgress();
                this.renderLevels();
                ui.updateCoinUI();
            },
            loadProgress() {
                const saved = localStorage.getItem('math_puzzle_solved');
                if (saved) this.solvedLevels = JSON.parse(saved);
                const last = localStorage.getItem('math_puzzle_last');
                if (last) {
                    this.currentLevel = parseInt(last);
                } else {
                    this.currentLevel = 1;
                }
                while (this.solvedLevels.includes(this.currentLevel) && this.currentLevel < this.totalLevels) {
                    this.currentLevel++;
                }
                const savedCoins = localStorage.getItem('math_puzzle_coins');
                if (savedCoins !== null) this.coins = parseInt(savedCoins);
            },
            saveProgress() {
                localStorage.setItem('math_puzzle_solved', JSON.stringify(this.solvedLevels));
                localStorage.setItem('math_puzzle_last', this.currentLevel.toString());
                localStorage.setItem('math_puzzle_coins', this.coins.toString());
            },
            resetProgress() {
                if (confirm('ÿ¢€åÿß ÿßÿ≤ Ÿæÿß⁄© ⁄©ÿ±ÿØŸÜ Ÿæ€åÿ¥ÿ±ŸÅÿ™ ÿÆŸàÿØ ŸÖÿ∑ŸÖÿ¶ŸÜ Ÿáÿ≥ÿ™€åÿØÿü')) {
                    this.solvedLevels = [];
                    this.currentLevel = 1;
                    this.coins = 20;
                    this.saveProgress();
                    this.renderLevels();
                    ui.updateCoinUI();
                    ui.showScreen('main-menu');
                }
            },
            renderLevels() {
                const container = document.getElementById('levels-container');
                container.innerHTML = '';
                for (let i = 1; i <= this.totalLevels; i++) {
                    const div = document.createElement('div');
                    div.className = 'level-card';
                    const isSolved = this.solvedLevels.includes(i);
                    const isLocked = i > 1 && !this.solvedLevels.includes(i - 1) && i !== this.currentLevel;
                    if (isSolved) div.classList.add('solved');
                    if (isLocked) div.classList.add('locked');
                    if (i === this.currentLevel) div.classList.add('current');
                    div.textContent = this.toPersianDigits(i);
                    if (!isLocked) div.onclick = () => this.startLevel(i);
                    container.appendChild(div);
                }
            },
            toPersianDigits(n) {
                const farsi = ['€∞', '€±', '€≤', '€≥', '€¥', '€µ', '€∂', '€∑', '€∏', '€π'];
                return n.toString().replace(/\d/g, x => farsi[x]);
            },
            startLevel(levelNum) {
                this.currentLevel = levelNum;
                this.hintsUsedInLevel = 0;
                this.saveProgress();
                ui.showScreen('game-screen');
                ui.hideWinModal();
                document.getElementById('level-indicator').textContent = `ŸÖÿ±ÿ≠ŸÑŸá ${this.toPersianDigits(levelNum)}`;
                this.updateHintUI();
                this.generateGrid(levelNum);
                this.startTimer();
            },
            updateHintUI() {
                const remaining = this.maxHintsPerLevel - this.hintsUsedInLevel;
                const total = this.maxHintsPerLevel;
                document.getElementById('hint-count').textContent = `${this.toPersianDigits(remaining)}/${this.toPersianDigits(total)}`;
            },
            generateGrid(level) {
                const size = 5;
                const grid = document.getElementById('math-grid');
                grid.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
                grid.innerHTML = '';
                this.gridData = Array.from({ length: size }, (_, y) => Array.from({ length: size }, (_, x) => ({ x, y, type: 'empty', val: '' })));
                this.selectedCell = null;
                let maxVal = 10;
                let allowedOps = ['+', '-'];
                if (level > 10) maxVal = 15;
                if (level > 20) { maxVal = 20; allowedOps.push('√ó'); }
                if (level > 40) { maxVal = 30; }
                if (level > 60) { maxVal = 50; allowedOps.push('√∑'); }
                if (level > 80) maxVal = 100;
                const getRand = (max) => Math.floor(Math.random() * max) + 1;
                const getOp = () => allowedOps[Math.floor(Math.random() * allowedOps.length)];
                const calc = (a, b, op) => {
                    if (op === '+') return a + b;
                    if (op === '-') return a - b;
                    if (op === '√ó') return a * b;
                    if (op === '√∑') return a / b;
                    return 0;
                };
                const isValidOp = (a, b, op) => {
                    if (op === '-') return a - b > 0;
                    if (op === '√∑') return b !== 0 && a % b === 0 && a / b > 0;
                    if (op === '√ó') return a * b < 1000;
                    return true;
                };
                let a, b, c, d, op1, op2, op3, op4, r1, r2, r3, r4;
                let valid = false;
                let attempts = 0;
                while (!valid && attempts < 500) {
                    attempts++;
                    a = getRand(maxVal); b = getRand(maxVal);
                    c = getRand(maxVal); d = getRand(maxVal);
                    op1 = getOp(); op2 = getOp(); op3 = getOp(); op4 = getOp();
                    if (isValidOp(a, b, op1) && isValidOp(c, d, op4) && isValidOp(a, c, op2) && isValidOp(b, d, op3)) {
                        r1 = calc(a, b, op1); r2 = calc(c, d, op4); r3 = calc(a, c, op2); r4 = calc(b, d, op3);
                        if (r1 > 0 && r2 > 0 && r3 > 0 && r4 > 0) valid = true;
                    }
                }
                if (!valid) { a = 5; b = 3; c = 2; d = 4; op1 = op2 = op3 = op4 = '+'; r1 = 8; r2 = 6; r3 = 7; r4 = 7; }
                this.gridData[0][0] = { type: 'input', val: '', correct: a, x:0, y:0 };
                this.gridData[0][1] = { type: 'operator', val: op1 };
                this.gridData[0][2] = { type: 'input', val: '', correct: b, x:2, y:0 };
                this.gridData[0][3] = { type: 'operator', val: '=' };
                this.gridData[0][4] = { type: 'result', val: r1 };
                this.gridData[1][0] = { type: 'operator', val: op2 };
                this.gridData[1][2] = { type: 'operator', val: op3 };
                this.gridData[2][0] = { type: 'input', val: '', correct: c, x:0, y:2 };
                this.gridData[2][1] = { type: 'operator', val: op4 };
                this.gridData[2][2] = { type: 'input', val: '', correct: d, x:2, y:2 };
                this.gridData[2][3] = { type: 'operator', val: '=' };
                this.gridData[2][4] = { type: 'result', val: r2 };
                this.gridData[3][0] = { type: 'operator', val: '=' };
                this.gridData[3][2] = { type: 'operator', val: '=' };
                this.gridData[4][0] = { type: 'result', val: r3 };
                this.gridData[4][2] = { type: 'result', val: r4 };
                const inputs = [this.gridData[0][0], this.gridData[0][2], this.gridData[2][0], this.gridData[2][2]];
                if (level <= 5) {
                    [0, 1, 2].forEach(idx => { inputs[idx].val = inputs[idx].correct; inputs[idx].isFixed = true; });
                } else if (level <= 15) {
                    [0, 1].forEach(idx => { inputs[idx].val = inputs[idx].correct; inputs[idx].isFixed = true; });
                } else if (level <= 30) {
                    [0].forEach(idx => { inputs[idx].val = inputs[idx].correct; inputs[idx].isFixed = true; });
                }
                this.renderGrid();
            },
            renderGrid() {
                const grid = document.getElementById('math-grid');
                grid.innerHTML = '';
                this.gridData.forEach((row, y) => {
                    row.forEach((cell, x) => {
                        const div = document.createElement('div');
                        div.className = `cell ${cell.type}`;
                        if (cell.type === 'input') {
                            div.textContent = cell.val !== '' ? this.toPersianDigits(cell.val) : '';
                            if (cell.isFixed) { div.classList.add('fixed'); } else { div.onclick = () => this.selectCell(x, y); }
                            if (cell.val !== '') {
                                if (parseInt(cell.val) === cell.correct) { div.classList.add('correct'); } else { div.classList.add('incorrect'); }
                            }
                            if (this.selectedCell && this.selectedCell.x === x && this.selectedCell.y === y) { div.classList.add('selected'); }
                        } else {
                            div.textContent = this.toPersianDigits(cell.val);
                        }
                        grid.appendChild(div);
                    });
                });
            },
            selectCell(x, y) {
                this.selectedCell = { x, y };
                audio.play('click');
                this.renderGrid();
            },
            inputNumber(num) {
                if (!this.selectedCell) return;
                const cell = this.gridData[this.selectedCell.y][this.selectedCell.x];
                if (cell.isFixed) return;
                const current = cell.val.toString();
                if (current.length < 3) {
                    const newVal = current === '' ? num.toString() : current + num;
                    cell.val = parseInt(newVal);
                    audio.play('click');
                    this.renderGrid();
                    this.checkWin();
                }
            },
            clearCell() {
                if (!this.selectedCell) return;
                const cell = this.gridData[this.selectedCell.y][this.selectedCell.x];
                if (cell.isFixed) return;
                cell.val = '';
                audio.play('click');
                this.renderGrid();
            },
            checkWin() {
                let allCorrect = true;
                let anyInput = false;
                this.gridData.forEach(row => {
                    row.forEach(cell => {
                        if (cell.type === 'input') {
                            anyInput = true;
                            if (cell.val === '' || parseInt(cell.val) !== cell.correct) allCorrect = false;
                        }
                    });
                });
                if (anyInput && allCorrect) this.handleWin();
            },
            handleWin() {
                clearInterval(this.timerInterval);
                const alreadySolved = this.solvedLevels.includes(this.currentLevel);
                if (!alreadySolved) {
                    this.solvedLevels.push(this.currentLevel);
                    this.coins += this.winReward;
                }
                audio.play('win');
                ui.showWinModal();
                ui.updateCoinUI();
                this.saveProgress();
            },
            useHint() {
                if (this.hintsUsedInLevel >= this.maxHintsPerLevel) {
                    alert('ŸÖÿ≠ÿØŸàÿØ€åÿ™ ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ ÿ±ÿßŸáŸÜŸÖÿß ÿØÿ± ÿß€åŸÜ ŸÖÿ±ÿ≠ŸÑŸá ÿ™ŸÖÿßŸÖ ÿ¥ÿØŸá ÿßÿ≥ÿ™!');
                    return;
                }
                if (this.coins < this.hintCost) {
                    alert('ÿ≥⁄©Ÿá ⁄©ÿßŸÅ€å ŸÜÿØÿßÿ±€åÿØ!');
                    return;
                }
                const hiddenInputs = [];
                this.gridData.forEach(row => {
                    row.forEach(cell => {
                        if (cell.type === 'input' && cell.val.toString() !== cell.correct.toString()) {
                            hiddenInputs.push(cell);
                        }
                    });
                });
                if (hiddenInputs.length > 0) {
                    const randomCell = hiddenInputs[Math.floor(Math.random() * hiddenInputs.length)];
                    randomCell.val = randomCell.correct;
                    this.coins -= this.hintCost;
                    this.hintsUsedInLevel++;
                    this.updateHintUI();
                    ui.updateCoinUI();
                    audio.play('click');
                    this.renderGrid();
                    this.saveProgress();
                    this.checkWin();
                }
            },
            nextLevel() {
                if (this.currentLevel < this.totalLevels) {
                    this.startLevel(this.currentLevel + 1);
                } else {
                    ui.showScreen('level-select');
                }
            },
            startTimer() {
                this.timer = 0;
                if (this.timerInterval) clearInterval(this.timerInterval);
                this.updateTimerDisplay();
                this.timerInterval = setInterval(() => {
                    this.timer++;
                    this.updateTimerDisplay();
                }, 1000);
            },
            updateTimerDisplay() {
                const mins = Math.floor(this.timer / 60).toString().padStart(2, '0');
                const secs = (this.timer % 60).toString().padStart(2, '0');
                document.getElementById('timer').textContent = `${this.toPersianDigits(mins)}:${this.toPersianDigits(secs)}`;
            }
        };

        const gfxEngine = {
            canvas: null,
            ctx: null,
            numbers: [],
            active: false,
            rafId: null,
            persianDigits: ['€∞', '€±', '€≤', '€≥', '€¥', '€µ', '€∂', '€∑', '€∏', '€π'],

            init() {
                this.canvas = document.getElementById('gfx-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
                
                for (let i = 0; i < 200; i++) {
                    this.numbers.push(this.createNumber());
                }
                
                const enabled = localStorage.getItem('gfxEnabled') !== 'false';
                document.getElementById('gfx-toggle').checked = enabled;
                if (enabled) this.start();
            },

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            },

            createNumber() {
                // Spreading coordinates wider than the screen to ensure coverage after 3D projection
                const spread = 2; 
                return {
                    x: (Math.random() * spread - (spread - 1) / 2) * this.canvas.width,
                    y: Math.random() * this.canvas.height,
                    z: Math.random() * 1500,
                    val: this.persianDigits[Math.floor(Math.random() * 10)],
                    speed: 1.5 + Math.random() * 4,
                    opacity: 0.1 + Math.random() * 0.4,
                    fontSize: 12 + Math.random() * 45
                };
            },

            start() {
                if (this.active) return;
                this.active = true;
                localStorage.setItem('gfxEnabled', 'true');
                document.getElementById('gfx-canvas').style.opacity = '0.6';
                this.animate();
            },

            stop() {
                this.active = false;
                localStorage.setItem('gfxEnabled', 'false');
                document.getElementById('gfx-canvas').style.opacity = '0';
                if (this.rafId) cancelAnimationFrame(this.rafId);
            },

            animate() {
                if (!this.active) return;
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.numbers.forEach(num => {
                    num.y += num.speed;
                    num.z -= 2;
                    
                    if (num.y > this.canvas.height || num.z < 0) {
                        const newNum = this.createNumber();
                        Object.assign(num, newNum);
                        num.y = -100;
                        num.z = 1500;
                    }

                    const scale = 600 / (600 + num.z);
                    const x = (num.x - this.canvas.width / 2) * scale + this.canvas.width / 2;
                    const y = num.y;
                    const size = num.fontSize * scale;

                    this.ctx.font = `bold ${size}px Vazirmatn`;
                    this.ctx.fillStyle = `rgba(162, 155, 254, ${num.opacity * scale})`;
                    this.ctx.fillText(num.val, x, y);
                });

                this.rafId = requestAnimationFrame(() => this.animate());
            }
        };

        window.ui = ui;
        window.game = game;
        window.audio = audio;
        window.gfxEngine = gfxEngine;

        // Tilt effect for the grid
        document.addEventListener('mousemove', (e) => {
            const grid = document.getElementById('math-grid');
            if (!grid || !grid.offsetParent) return;
            
            const xAxis = (window.innerWidth / 2 - e.pageX) / 25;
            const yAxis = (window.innerHeight / 2 - e.pageY) / 25;
            grid.style.transform = `rotateY(${xAxis}deg) rotateX(${yAxis}deg)`;
        });

        // For mobile orientation
        window.addEventListener('deviceorientation', (e) => {
            const grid = document.getElementById('math-grid');
            if (!grid || !grid.offsetParent) return;
            
            const x = e.beta / 5; // range ~ -180 to 180
            const y = e.gamma / 5; // range ~ -90 to 90
            grid.style.transform = `rotateX(${x}deg) rotateY(${y}deg)`;
        }, true);

        window.addEventListener('DOMContentLoaded', () => {
            ui.init();
            game.init();
            audio.init();
            gfxEngine.init();
        });

        window.app = {
            openArvin: (event) => {
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                try { window.audio.play('click'); } catch(e) {}
                ui.openAds();
            }
        };
    </script>
</body>
</html>